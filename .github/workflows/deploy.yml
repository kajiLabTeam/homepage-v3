name: Deploy to Sakura Server

on:
  push:
    branches:
      - release

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout your repository using git
        uses: actions/checkout@v4

      # Node.js と pnpm のセットアップ
      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 10
          run_install: false
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      # キャッシュ設定を追加
      - name: Cache Astro assets
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            node_modules/.astro/assets
          key: ${{ runner.OS }}-node-astro-assets-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.OS }}-node-astro-assets-

      # 依存関係のインストールとビルド
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ビルド
      - name: Build the project
        run: pnpm build

      # さくらサーバにSSHでアクセスするための設定
      - name: Setup SSH
        run: echo "$SSH_PRIVATE_KEY" > key && chmod 600 key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

      # さくらサーバにSSHで接続して、rsyncでファイルを転送
      - name: Deploy to Sakura Server
        run: |
          rsync -acv --delete -e "ssh -i key -o StrictHostKeyChecking=no" dist/ $SSH_USERNAME@$SSH_HOSTNAME:$DESTINATION_PATH
        env:
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
          SSH_HOSTNAME: ${{ secrets.SSH_HOSTNAME }}
          DESTINATION_PATH: ${{ secrets.DESTINATION_PATH }}

      # CDNのキャッシュ削除
      - name: Delete CDN Caches
        run: |
          curl -X DELETE "$CACHE_DELETE_API_URL" -H "Content-Type:application/json" -H "X-Auth-Email: $CACHE_AUTH_EMAIL" -H "X-Auth-Key: $CACHE_AUTH_KEY" --data '{"purge_everything":true}'
        env:
          CACHE_DELETE_API_URL: ${{ secrets.CACHE_DELETE_API_URL }}
          CACHE_AUTH_EMAIL: ${{ secrets.CACHE_AUTH_EMAIL }}
          CACHE_AUTH_KEY: ${{ secrets.CACHE_AUTH_KEY }}
